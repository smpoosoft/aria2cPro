# Aria2c Pro: 多态下载工具

一个基于 aria2c 引擎的轻量化下载方案。通过对运行环境的感知，提供三种模态以应对不同的下载场景，核心逻辑在于通过“内存中转”技术规避传统下载对固态硬盘（SSD）造成的随机碎写压力。

## 运行模态详解

### 模态 A：Node.js 引擎模式 (硬盘保护)
**适用场景**：需要最大限度减少硬盘损耗的大文件下载或长效挂机。
- **运行载体**：`aria2c_engine.mjs` (Node.js 环境)。
- **隔离机制**：利用 Linux `tmpfs` (/dev/shm) 建立内存 A 区，强制拦截 aria2c 的分片碎写。
- **落盘逻辑**：数据在内存聚合完整后，由 Node.js 执行流式顺序搬运至目标硬盘。
- **特有功能**：具备文件系统权限，支持通过 Web 页面直接物理删除硬盘上的文件。

### 模态 B：浏览器直下模式 (即时工具)
**适用场景**：临时性的小文件下载，无需启动 Node.js 环境。
- **运行载体**：`aria2c_toolbox.html` (浏览器 Tab 1)。
- **逻辑**：利用浏览器原生下载协议进行数据获取。

### 模态 C：命令生成模式 (环境迁移)
**适用场景**：需要在其他服务器终端执行任务，或手动调优下载参数。
- **运行载体**：`aria2c_toolbox.html` (浏览器 Tab 2)。
- **功能**：基于当前配置，快速生成包含硬盘保护参数（如 `--file-allocation=none`）的 shell 命令。



---

## 架构演变历程

本项目从最初的“命令生成器”起步，经历了一系列针对“单文件哲学”与“硬件保护”的权衡与演变：

1. **模态 C 的诞生 (原型阶段)**：
   最初仅作为一个简单的 HTML 工具，解决手动输入 aria2c 繁琐参数的问题。

2. **前端嵌入式 Linux 尝试 (已放弃)**：
   曾讨论通过 WebAssembly (Wasm) 在浏览器中嵌入轻量级 Linux 镜像。
   - **放弃原因**：虽然实现了“单文件自包含引擎”的设想，但浏览器沙盒对内存 (`SharedArrayBuffer`) 和指令集的限制导致性能损耗巨大，且由于安全策略，无法直接绕过浏览器写入物理硬盘，未能真正解决碎写问题。

3. **Node.js 引擎化 (模态 A 的确立)**：
   为了追求原生 I/O 性能，将引擎环境迁移至 Node.js。通过自包含 Base64 编码的二进制，实现了不依赖宿主机安装、直接调用系统内存盘 (/dev/shm) 的能力。

4. **Trinity 三模态集成 (最终形态)**：
   确定了“工具与引擎分离”但“数据共享”的格局。通过统一 IndexedDB 规范，使得独立运行的 HTML 工具与 Node.js 引擎能够共享同一套下载历史记录。

---

## TODO LIST (功能对齐与待实现)

基于前期讨论的愿景，以下功能在当前版本已实现或尚待完善：

| 功能特性 | 愿景描述 | 当前实现状态 |
| :--- | :--- | :--- |
| **自包含引擎** | 无需安装 aria2c，二进制集成在脚本内 | **已实现** (Node 版支持 Base64 释放) |
| **历史记录共享** | HTML 工具与 Node 引擎共享下载记录 | **已实现** (基于 IndexedDB 域名共享) |
| **物理文件删除** | 在 UI 界面直接销毁硬盘文件 | **已实现** (仅限 Node 引擎模式) |
| **多任务队列管理** | 支持多个任务排队下载，控制并发数 | **待实现** (目前为单任务顺序执行) |
| **Gzip 二进制压缩** | 减小 mjs 文件中二进制 Base64 的体积 | **待实现** (目前为原始 Base64 编码) |
| **Windows 环境适配** | 自动识别 Windows 并创建内存映射盘 (ImDisk) | **待实现** (目前仅支持 Linux /dev/shm) |
| **断点续传状态拉取** | Web 页面实时显示 Node 后台的下载进度 | **待实现** (目前仅在终端输出进度) |

---

## 使用方式

1. **引擎初始化 (Linux)**：
   执行 `base64 -w 0 $(which aria2c)`，将生成的字符串贴入 `aria2c_engine.mjs`。
2. **启动引擎**：
   运行 `node aria2c_engine.mjs`，访问 `http://localhost:3000`。
3. **使用工具箱**：
   直接在浏览器打开 `aria2c_toolbox.html`，切换 Tab 选择直下或生成命令。
