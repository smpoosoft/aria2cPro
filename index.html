<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aria2c Ultimate Management</title>
    <style>
        :root {
            --bg: #0d1117; --panel: #161b22; --border: #30363d;
            --text-main: #c9d1d9; --text-dim: #8b949e; --accent: #58a6ff;
            --danger: #f85149; --success: #3fb950; --cmd-bg: #010409;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* ä¸Šéƒ¨åŒºåŸŸ (5/6 é«˜åº¦) */
        .workspace { flex: 5; display: flex; overflow: hidden; border-bottom: 1px solid var(--border); }

        /* å·¦ä¾§å†å²åˆ—è¡¨ (3/4 å®½åº¦) */
        .history-pane { flex: 3; display: flex; flex-direction: column; background: var(--bg); }
        .header-bar { padding: 16px 24px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .header-bar h2 { font-size: 0.9rem; color: var(--accent); letter-spacing: 1px; }
        .history-list { flex: 1; overflow-y: auto; padding: 20px; }

        .item-card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; position: relative; transition: 0.2s; }
        .item-card:hover { border-color: #8b949e; }
        .card-meta { margin-bottom: 10px; }
        .meta-label { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; display: block; margin-bottom: 4px; }
        .meta-value { font-family: ui-monospace, SFMono-Regular, monospace; font-size: 0.85rem; word-break: break-all; }
        .val-url { color: var(--text-dim); }
        .val-path { color: var(--success); font-weight: 500; }
        .card-delete { position: absolute; top: 16px; right: 16px; background: rgba(248,81,73,0.1); border: 1px solid var(--danger); color: var(--danger); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        .card-delete:hover { background: var(--danger); color: white; }

        /* å³ä¾§è®¾ç½®é¢æ¿ (1/4 å®½åº¦) */
        .settings-pane { flex: 1; min-width: 300px; background: var(--panel); border-left: 1px solid var(--border); padding: 24px; overflow-y: auto; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-dim); margin-bottom: 8px; }
        input, select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; outline: none; font-size: 0.9rem; }
        input:focus { border-color: var(--accent); }
        .auth-btn { background: #21262d; border: 1px solid var(--border); color: var(--accent); width: 100%; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; margin-top: 5px; }

        /* åº•éƒ¨å‘½ä»¤åŒºåŸŸ (1/6 é«˜åº¦) */
        .command-bar { flex: 1; background: var(--cmd-bg); display: flex; align-items: center; justify-content: center; padding: 0 40px; position: relative; }
        #final-cmd { font-family: 'JetBrains Mono', 'Fira Code', monospace; color: #7ee787; font-size: 1.1rem; text-align: center; cursor: pointer; word-break: break-all; padding: 15px; transition: 0.2s; border-radius: 8px; }
        #final-cmd:hover { background: rgba(255,255,255,0.05); color: #aff5b4; }
        .copy-hint { position: absolute; top: 10px; font-size: 0.7rem; color: var(--text-dim); }

        /* å¼¹çª— */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; }
        .modal { background: var(--panel); border: 1px solid var(--border); padding: 24px; border-radius: 12px; width: 400px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="workspace">
        <section class="history-pane">
            <div class="header-bar">
                <h2>HISTORY LIST</h2>
                <div id="dir-status" style="font-size: 0.7rem;">ğŸ“ æœªæŒ‚è½½æœ¬åœ°ç›®å½•</div>
            </div>
            <div class="history-list" id="history-list"></div>
        </section>

        <aside class="settings-pane">
            <div class="form-group">
                <label>DOWNLOAD URL</label>
                <input type="text" id="url" placeholder="Click to paste http..." autocomplete="off">
            </div>
            <div class="form-group">
                <label>FILENAME (-O)</label>
                <input type="text" id="out" placeholder="Auto-parsed">
            </div>
            <div class="form-group">
                <label>DIRECTORY (-D)</label>
                <input type="text" id="dir" value="/smpoo_code/ai/models/">
                <button class="auth-btn" id="btn-auth">ğŸ” æˆæƒæœ¬åœ°ç›®å½•åˆ é™¤æƒé™</button>
            </div>
            <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><label>THREADS (-S)</label><input type="number" id="split" value="16"></div>
                <div><label>CONN (-X)</label><input type="number" id="conn" value="16"></div>
            </div>
            <div class="form-group">
                <label>ALLOCATION</label>
                <select id="alloc">
                    <option value="falloc">falloc (Linux/SSD)</option>
                    <option value="trunc">trunc (Fast)</option>
                    <option value="prealloc">prealloc</option>
                    <option value="none">none</option>
                </select>
            </div>
        </aside>
    </div>

    <footer class="command-bar">
        <span class="copy-hint">ç‚¹å‡»å‘½ä»¤ï¼šå¤åˆ¶ä»£ç å¹¶è®°å½•å†å²</span>
        <div id="final-cmd">aria2c ...</div>
    </footer>

    <div class="modal-overlay" id="modal-delete">
        <div class="modal">
            <h3 style="color:var(--danger); margin-bottom:12px;">åˆ é™¤è®°å½•</h3>
            <p style="font-size: 0.9rem; margin-bottom:16px;">ç¡®å®šè¦ç§»é™¤è¯¥ä¸‹è½½è®°å½•å—ï¼Ÿ</p>
            <label style="display:flex; align-items:center; gap:8px; font-size:0.85rem; cursor:pointer;">
                <input type="checkbox" id="check-physical" style="width:auto;"> åŒæ—¶å½»åº•åˆ é™¤ç‰©ç†æ–‡ä»¶åŠ .aria2 ç¢ç‰‡
            </label>
            <div class="modal-footer">
                <button class="auth-btn" style="width:auto;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="auth-btn" id="btn-confirm-del" style="width:auto; background:var(--danger); border-color:var(--danger); color:white;">ç¡®è®¤æ‰§è¡Œ</button>
            </div>
        </div>
    </div>

<script type="module">
    let db, rootHandle, pendingId, pendingFilename;

    // IndexedDB åˆå§‹åŒ–
    const openDB = () => {
        const req = indexedDB.open("aria2_manager", 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore("history", { keyPath: "id", autoIncrement: true });
        req.onsuccess = e => { db = e.target.result; renderHistory(); };
    };

    const els = {
        url: document.querySelector('#url'), out: document.querySelector('#out'),
        dir: document.querySelector('#dir'), split: document.querySelector('#split'),
        conn: document.querySelector('#conn'), alloc: document.querySelector('#alloc'),
        cmd: document.querySelector('#final-cmd'), hist: document.querySelector('#history-list')
    };

    // ç›®å½•æˆæƒ
    document.querySelector('#btn-auth').onclick = async () => {
        rootHandle = await window.showDirectoryPicker();
        document.querySelector('#dir-status').textContent = `âœ… å·²æ¥ç®¡ç›®å½•ï¼š${rootHandle.name}`;
        document.querySelector('#dir-status').style.color = 'var(--success)';
    };

    const update = () => {
        const u = els.url.value || '[URL]';
        const d = els.dir.value;
        const o = els.out.value;
        els.cmd.textContent = `aria2c -c -x ${els.conn.value} -s ${els.split.value} -k 1M --file-allocation=${els.alloc.value} -d "${d}" ${o ? `-o "${o}"` : ''} "${u}"`;
    };

    // æ™ºèƒ½è§£æå¹¶ç²˜è´´
    els.url.onclick = async () => {
        if (!els.url.value) {
            const t = await navigator.clipboard.readText();
            if (t.startsWith('http')) {
                els.url.value = t;
                const path = new URL(t).pathname;
                let name = path.split('/').pop();
                if (name.includes('?')) name = name.split('?')[0];
                els.out.value = decodeURIComponent(name);
                update();
            }
        }
    };

    // ç‚¹å‡»å¤åˆ¶å¹¶ä¿å­˜
    els.cmd.onclick = () => {
        if (!els.url.value) return;
        const cmdText = els.cmd.textContent;
        const name = els.out.value || els.url.value.split('/').pop();
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").add({
            url: els.url.value,
            path: els.dir.value + name,
            filename: name,
            command: cmdText,
            time: new Date().toLocaleString()
        });
        tx.oncomplete = () => {
            renderHistory();
            navigator.clipboard.writeText(cmdText);
            alert("ğŸ“‹ å‘½ä»¤å·²å¤åˆ¶ï¼Œå†å²å·²å­˜å…¥æ•°æ®åº“ï¼");
        };
    };

    const renderHistory = () => {
        if (!db) return;
        db.transaction("history", "readonly").objectStore("history").getAll().onsuccess = e => {
            els.hist.innerHTML = e.target.result.reverse().map(i => `
                <div class="item-card">
                    <button class="card-delete" onclick="triggerDelete(${i.id}, '${i.filename}')">åˆ é™¤</button>
                    <div class="card-meta">
                        <span class="meta-label">Source URL</span>
                        <div class="meta-value val-url">${i.url}</div>
                    </div>
                    <div class="card-meta">
                        <span class="meta-label">Local Save Path</span>
                        <div class="meta-value val-path">${i.path}</div>
                    </div>
                    <div style="font-size:0.65rem; color:var(--text-dim)">CREATED: ${i.time}</div>
                </div>
            `).join('');
        };
    };

    window.triggerDelete = (id, fname) => {
        pendingId = id; pendingFilename = fname;
        document.querySelector('#modal-delete').style.display = 'flex';
    };

    window.closeModal = () => document.querySelector('#modal-delete').style.display = 'none';

    document.querySelector('#btn-confirm-del').onclick = async () => {
        if (document.querySelector('#check-physical').checked && rootHandle) {
            try {
                await rootHandle.removeEntry(pendingFilename);
                await rootHandle.removeEntry(pendingFilename + ".aria2");
            } catch (err) { console.warn("æ–‡ä»¶æ¸…ç†è·³è¿‡ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰"); }
        }
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").delete(pendingId);
        tx.oncomplete = () => { closeModal(); renderHistory(); };
    };

    [els.url, els.out, els.dir, els.split, els.conn, els.alloc].forEach(el => el.oninput = update);
    openDB(); update();
</script>
</body>
</html>
