<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aria2c Pro - Grid Logic</title>
    <style>
        /* åŸºç¡€å¤ä½ */
        * { padding: 0; margin: 0; overflow: hidden; font-size: 14px; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #0d1117; color: #c9d1d9; }

        /* å¤–å±‚åŒ…è£…ï¼šä¸‰è¡Œç»“æ„ (æ ‡é¢˜ 40px, ä¸»åŒº 1fr, å‘½ä»¤åŒº 80px) */
        .wrapper {
            display: grid;
            grid-template-rows: 40px 1fr 80px;
            width: 100vw;
            height: 100vh;
        }

        /* é¡¶éƒ¨æ ‡é¢˜è¡Œ */
        .pageTitle {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            padding: 0 20px;
            color: #58a6ff;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* å·¥ä½œåŒºåŸŸï¼šä¸¤åˆ—ç»“æ„ (å†å² 1fr, å‚æ•° 20vw) */
        .workzone {
            display: grid;
            grid-template-columns: 1fr 20vw;
            column-gap: 4px;
            background: #010409; /* ç¼éš™é¢œè‰² */
        }

        /* å†å²é¢æ¿å¸ƒå±€ (æ ‡é¢˜ 64px, åˆ—è¡¨ 1fr) */
        .panelHis {
            display: grid;
            grid-template-rows: 64px 1fr;
            background: #0d1117;
        }

        .hisTitle {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 0 20px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
        }

        .hisTitle span { cursor: pointer; color: #8b949e; transition: 0.2s; }
        .hisTitle span:hover { color: #58a6ff; }
        .hisTitle .main-label { color: #f0f6fc; font-weight: 600; margin-right: 10px; cursor: default; }

        /* å†å²åˆ—è¡¨é¡¹å¸ƒå±€ (é€‰æ‹© | URL | Path | åˆ é™¤) */
        ul { list-style: none; overflow-y: auto; padding: 10px; }
        .hisItem {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 40px;
            align-items: center;
            height: 48px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 4px;
            margin-bottom: 4px;
            padding: 0 10px;
            transition: 0.2s;
        }

        .hisItem:hover { border-color: #8b949e; background: #1c2128; }
        .hisItem span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 10px; font-family: monospace; font-size: 12px; cursor: pointer; }
        .hisItem .url-val { color: #8b949e; }
        .hisItem .path-val { color: #3fb950; }

        /* å‚æ•°æ§åˆ¶åŒºåŸŸ */
        .panelParam {
            background: #161b22;
            padding: 20px;
            border-left: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .form-field { display: flex; flex-direction: column; gap: 5px; }
        .form-field label { font-size: 12px; color: #8b949e; font-weight: bold; }
        input, select { background: #0d1117; border: 1px solid #30363d; color: white; padding: 8px; border-radius: 4px; outline: none; }
        input:focus { border-color: #58a6ff; }

        /* å‘½ä»¤è¾“å‡ºåŒºåŸŸ */
        .commandZone {
            width: 100vw;
            background: #000;
            border-top: 2px solid #58a6ff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 40px;
            color: #7ee787;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            text-align: center;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 100; }
        .modal-body { background: #161b22; border: 1px solid #30363d; padding: 25px; border-radius: 8px; width: 350px; }
        .btn-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 5px 12px; border-radius: 4px; cursor: pointer; border: 1px solid #30363d; background: #21262d; color: #c9d1d9; }
        .btn-danger { border-color: #f85149; color: #f85149; }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="pageTitle">ARIA2C PRO - NUC AI DOWNLOADER</div>

        <div class="workzone">
            <div class="panelHis">
                <div class="hisTitle">
                    <span class="main-label">ä¸‹è½½å†å²</span>
                    <span id="btn-clear">æ¸…ç©º</span>
                    <span id="btn-all">å…¨é€‰</span>
                    <span id="btn-rev">åé€‰</span>
                    <span id="dir-auth" style="font-size: 12px; margin-left: auto;">ğŸ” æˆæƒåˆ é™¤æƒé™</span>
                </div>
                <ul id="history-list">
                    </ul>
            </div>

            <div class="panelParam">
                <div class="form-field">
                    <label>DOWNLOAD URL</label>
                    <input type="text" id="url" placeholder="ç‚¹å‡»ç²˜è´´ URL..." autocomplete="off">
                </div>
                <div class="form-field">
                    <label>FILENAME (-O)</label>
                    <input type="text" id="out" placeholder="è‡ªåŠ¨è§£ææ–‡ä»¶å">
                </div>
                <div class="form-field">
                    <label>DIRECTORY (-D)</label>
                    <input type="text" id="dir" value="/smpoo_code/ai/models/">
                </div>
                <div class="form-field">
                    <label>THREADS/CONN</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                        <input type="number" id="split" value="16">
                        <input type="number" id="conn" value="16">
                    </div>
                </div>
                <div class="form-field">
                    <label>ALLOCATION</label>
                    <select id="alloc">
                        <option value="falloc">falloc (Linux)</option>
                        <option value="trunc">trunc</option>
                        <option value="prealloc">prealloc</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="commandZone" id="final-cmd">ç‚¹å‡»æ­¤å¤„å¤åˆ¶æœ€ç»ˆç”Ÿæˆçš„å‘½ä»¤</div>
    </div>

    <div class="modal" id="del-modal">
        <div class="modal-body">
            <h4 style="margin-bottom: 10px; color: #f85149;">ç¡®è®¤åˆ é™¤è®°å½•ï¼Ÿ</h4>
            <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer;">
                <input type="checkbox" id="physical-del"> åŒæ—¶ç‰©ç†åˆ é™¤æœ¬åœ°æ–‡ä»¶åŠç¢ç‰‡
            </label>
            <div class="btn-group">
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="btn-confirm-del">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

<script type="module">
    let db, rootHandle, pendingId, pendingFile;

    // 1. IndexedDB åˆå§‹åŒ–
    const openDB = () => {
        const req = indexedDB.open("aria2_grid_db", 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore("history", { keyPath: "id", autoIncrement: true });
        req.onsuccess = e => { db = e.target.result; render(); };
    };

    // 2. æ ¸å¿ƒé€»è¾‘
    const els = {
        url: document.getElementById('url'),
        out: document.getElementById('out'),
        dir: document.getElementById('dir'),
        split: document.getElementById('split'),
        conn: document.getElementById('conn'),
        alloc: document.getElementById('alloc'),
        cmd: document.getElementById('final-cmd'),
        hist: document.getElementById('history-list')
    };

    // è‡ªåŠ¨ç²˜è´´ä¸è§£æ
    els.url.onclick = async () => {
        if (!els.url.value) {
            const t = await navigator.clipboard.readText();
            if (t.startsWith('http')) {
                els.url.value = t;
                const path = new URL(t).pathname;
                els.out.value = decodeURIComponent(path.split('/').pop().split('?')[0]);
                update();
            }
        }
    };

    const update = () => {
        const cmd = `aria2c -c -x ${els.conn.value} -s ${els.split.value} -k 1M --file-allocation=${els.alloc.value} -d "${els.dir.value}" ${els.out.value ? `-o "${els.out.value}"` : ''} "${els.url.value || '[URL]'}"`;
        els.cmd.textContent = cmd;
    };

    // å†™å…¥å†å²
    els.cmd.onclick = () => {
        if (!els.url.value) return;
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").add({
            url: els.url.value,
            path: els.dir.value + (els.out.value || 'download'),
            filename: els.out.value,
            command: els.cmd.textContent
        });
        tx.oncomplete = () => {
            navigator.clipboard.writeText(els.cmd.textContent);
            render();
            alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
        };
    };

    // æˆæƒç›®å½•
    document.getElementById('dir-auth').onclick = async () => {
        rootHandle = await window.showDirectoryPicker();
        document.getElementById('dir-auth').textContent = `âœ… ç›®å½•å·²æ¥ç®¡`;
    };

    // æ¸²æŸ“åˆ—è¡¨
    const render = () => {
        if (!db) return;
        db.transaction("history", "readonly").objectStore("history").getAll().onsuccess = e => {
            els.hist.innerHTML = e.target.result.reverse().map(i => `
                <li class="hisItem">
                    <input type="checkbox" class="hisCheck">
                    <span class="url-val" onclick="navigator.clipboard.writeText('${i.url}')">${i.url}</span>
                    <span class="path-val" onclick="navigator.clipboard.writeText('${i.path}')">${i.path}</span>
                    <svg onclick="triggerDel(${i.id}, '${i.filename}')" style="cursor:pointer" viewBox="0 0 16 16" fill="#f85149" width="16"><path d="M11 1.75V3h2.25a.75.75 0 010 1.5H2.75a.75.75 0 010-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75zM4.496 6.675a.75.75 0 10-1.492.15l.66 6.6A1.75 1.75 0 005.405 15h5.19c.9 0 1.652-.681 1.741-1.576l.66-6.6a.75.75 0 00-1.492-.149l-.66 6.6a.25.25 0 01-.249.225h-5.19a.25.25 0 01-.249-.225l-.66-6.6z"></path></svg>
                </li>
            `).join('');
        };
    };

    window.triggerDel = (id, file) => {
        pendingId = id; pendingFile = file;
        document.getElementById('del-modal').style.display = 'flex';
    };

    window.closeModal = () => document.getElementById('del-modal').style.display = 'none';

    document.getElementById('btn-confirm-del').onclick = async () => {
        if (document.getElementById('physical-del').checked && rootHandle && pendingFile) {
            try {
                await rootHandle.removeEntry(pendingFile);
                await rootHandle.removeEntry(pendingFile + ".aria2");
            } catch (e) {}
        }
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").delete(pendingId);
        tx.oncomplete = () => { closeModal(); render(); };
    };

    [els.url, els.out, els.dir, els.split, els.conn, els.alloc].forEach(el => el.oninput = update);
    openDB(); update();
</script>
</body>
</html>
