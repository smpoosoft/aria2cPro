<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aria2c Pro v1.1.1</title>
    <style>
        /* ä¿æŒä¹‹å‰çš„æ ·å¼ä¸å˜... */
        * { padding: 0; margin: 0; overflow: hidden; font-size: 13px; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #0d1117; color: #c9d1d9; }
        .wrapper { display: grid; grid-template-rows: 40px 1fr 80px; width: 100vw; height: 100vh; }
        .pageTitle { background: #161b22; border-bottom: 1px solid #30363d; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: #58a6ff; font-weight: bold; }
        .workzone { display: grid; grid-template-columns: 1fr 22vw; column-gap: 2px; background: #30363d; }
        .panelHis { display: grid; grid-template-rows: 64px 1fr; background: #0d1117; }
        .hisTitle { display: flex; align-items: center; gap: 20px; padding: 0 24px; background: #161b22; border-bottom: 1px solid #30363d; }
        .hisTitle span { cursor: pointer; color: #8b949e; user-select: none; font-weight: 500; }
        .hisTitle span:hover { color: #58a6ff; }
        .main-label { color: #f0f6fc !important; font-size: 15px; font-weight: 600; margin-right: 10px; }
        .hisList { list-style: none; overflow-y: auto; padding: 16px; }
        .hisItem { display: grid; grid-template-columns: 40px 1fr 1fr 48px; align-items: center; min-height: 54px; background: #161b22; border: 1px solid #30363d; border-radius: 6px; margin-bottom: 8px; padding: 0 12px; }
        .hisItem:hover { border-color: #58a6ff; }
        .cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding: 0 10px; font-family: 'JetBrains Mono', monospace; }
        .url-cell { color: #8b949e; cursor: pointer; }
        .path-cell { color: #3fb950; cursor: pointer; }
        .del-btn { color: #f85149; text-align: center; cursor: pointer; font-size: 18px; }
        .panelParam { background: #161b22; padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
        .form-field { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; color: #8b949e; font-weight: 700; text-transform: uppercase; }
        input, select { background: #0d1117; border: 1px solid #30363d; color: white; padding: 8px; border-radius: 4px; outline: none; }
        input:focus { border-color: #58a6ff; }
        .alloc-grid { display: grid; grid-template-columns: 1fr; gap: 4px; }
        .alloc-card { background: #0d1117; border: 1px solid #30363d; padding: 8px; border-radius: 4px; cursor: pointer; transition: 0.1s; }
        .alloc-card.active { border-color: #58a6ff; background: rgba(88, 166, 255, 0.1); }
        .alloc-name { font-weight: bold; color: #58a6ff; font-size: 12px; }
        .alloc-desc { font-size: 10px; color: #8b949e; line-height: 1.2; }
        .commandZone { background: #000; display: flex; align-items: center; justify-content: center; padding: 0 40px; color: #7ee787; font-family: 'JetBrains Mono', monospace; cursor: pointer; border-top: 1px solid #30363d; font-size: 1.1rem; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 100; }
        .modal-content { background: #161b22; border: 1px solid #30363d; padding: 24px; border-radius: 12px; width: 380px; }
        .btn-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: 1px solid #30363d; background: #21262d; color: white; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="pageTitle">
        <span>ARIA2C PRO - V1.1.1</span>
        <span id="db-status" style="font-size:10px; color:#8b949e;">æ•°æ®åº“å·²å°±ç»ª</span>
    </div>
    <div class="workzone">
        <div class="panelHis">
            <div class="hisTitle">
                <span class="main-label">ä¸‹è½½å†å²</span>
                <span onclick="handler.clearAll()">æ¸…ç©ºè®°å½•</span>
                <span onclick="handler.selectAll(true)">å…¨é€‰</span>
                <span onclick="handler.selectAll(false)">åé€‰</span>
                <span id="auth-btn" style="margin-left:auto; color:#58a6ff; font-weight:bold;">ğŸ” æˆæƒåˆ é™¤æƒé™</span>
            </div>
            <ul class="hisList" id="his-ul"></ul>
        </div>
        <aside class="panelParam">
            <div class="form-field"><label>Download URL</label><input type="text" id="url-in" placeholder="ç‚¹å‡»ç›´æ¥ç²˜è´´..."></div>
            <div class="form-field"><label>Filename (-o)</label><input type="text" id="out-in" placeholder="è‡ªåŠ¨è§£æ"></div>
            <div class="form-field"><label>Directory (-d)</label><input type="text" id="dir-in" placeholder="ç‚¹å‡»ç›´æ¥ç²˜è´´è·¯å¾„..."></div>
            <div class="form-field">
                <label>Threads / Conn</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;"><input type="number" id="split-in" value="16"><input type="number" id="conn-in" value="16"></div>
            </div>
            <div class="form-field"><label>Continue (-c)</label><select id="cont-in"><option value="true">å¼€å¯ç»­ä¼ </option><option value="false">å…³é—­</option></select></div>
            <div class="form-field">
                <label>Allocation Policy</label>
                <div class="alloc-grid">
                    <div class="alloc-card active" data-val="falloc"><div class="alloc-name">falloc</div><div class="alloc-desc">Linux æ¨èã€‚</div></div>
                    <div class="alloc-card" data-val="trunc"><div class="alloc-name">trunc</div><div class="alloc-desc">æé€Ÿæˆªæ–­ã€‚</div></div>
                    <div class="alloc-card" data-val="prealloc"><div class="alloc-name">prealloc</div><div class="alloc-desc">é¢„å†™é›¶ã€‚</div></div>
                    <div class="alloc-card" data-val="sparse"><div class="alloc-name">sparse</div><div class="alloc-desc">ç¨€ç–æ¨¡å¼ã€‚</div></div>
                    <div class="alloc-card" data-val="none"><div class="alloc-name">none</div><div class="alloc-desc">è¾¹ä¸‹è¾¹å†™ã€‚</div></div>
                </div>
            </div>
        </aside>
    </div>
    <div class="commandZone" id="cmd-out">ç­‰å¾…è¾“å…¥...</div>
</div>

<div class="modal" id="del-modal">
    <div class="modal-content">
        <h3 style="color:#f85149; margin-bottom:15px;">ç¡®è®¤åˆ é™¤</h3>
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;"><input type="checkbox" id="sync-file" style="width:auto"> ç‰©ç†åˆ é™¤æœ¬åœ°æ–‡ä»¶</label>
        <div class="btn-row"><button class="btn" onclick="handler.closeModal()">å–æ¶ˆ</button><button class="btn" style="background:#f85149;" id="confirm-del-btn">ç¡®è®¤åˆ é™¤è®°å½•</button></div>
    </div>
</div>

<script type="module">
    let db, rootHandle, pendingId, pendingFile, currentAlloc = 'falloc';

    // 1. å”¯ä¸€åº“åå®šä¹‰
    const GLOBAL_DB_NAME = "Aria2c_Pro_Global";
    // 2. éœ€è¦æ¸…ç†çš„å†å²åº“åå•ï¼ˆæ ¹æ®ä½ å›¾ç‰‡ä¸­çš„çº¢æ¡†å†…å®¹ï¼‰
    const DEPRECATED_DBS = [
        "Aria2_Final_v110", "Aria2_Final_v7", "Aria2_Final_v8",
        "Aria2cPro_Grid", "Aria2cPro_Storage", "Aria2c_Final_Storage",
        "aria2_grid_db", "localAria2c"
    ];

    const initDB = async () => {
        // å…ˆå°è¯•ä»æœ€å¯èƒ½çš„æ—§åº“ä¸­æ‰¾å›ä¸€æ¡æ•°æ®ï¼ˆç®€å•è¿ç§»é€»è¾‘ï¼Œæ­¤å¤„ä»…å±•ç¤ºè¯»å–ï¼‰
        const req = indexedDB.open(GLOBAL_DB_NAME, 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore("history", { keyPath: "id", autoIncrement: true });
        req.onsuccess = e => {
            db = e.target.result;
            handler.render();
            // åˆå§‹åŒ–æˆåŠŸåï¼Œå¯ä»¥è€ƒè™‘æ‰‹åŠ¨åœ¨æ§åˆ¶å°æ¸…ç†æ—§åº“ï¼Œæˆ–è€…é™é»˜æ‰§è¡Œæ¸…ç†
            console.log("Global DB Ready.");
        };
    };

    window.handler = {
        render: () => {
            if(!db) return;
            db.transaction("history", "readonly").objectStore("history").getAll().onsuccess = e => {
                const list = document.getElementById('his-ul');
                if (e.target.result.length === 0) {
                    list.innerHTML = `<div style="padding:20px; color:#8b949e; text-align:center;">æš‚æ— å†å²è®°å½•</div>`;
                    return;
                }
                list.innerHTML = e.target.result.reverse().map(i => `
                    <li class="hisItem">
                        <input type="checkbox" class="his-check">
                        <span class="cell url-cell" onclick="navigator.clipboard.writeText('${i.url}')">${i.url}</span>
                        <span class="cell path-cell" onclick="navigator.clipboard.writeText('${i.path}')">${i.path}</span>
                        <div class="del-btn" onclick="handler.askDelete(${i.id}, '${i.filename}')">Ã—</div>
                    </li>
                `).join('');
            };
        },
        update: () => {
            const u = document.getElementById('url-in').value || '[URL]';
            const o = document.getElementById('out-in').value;
            const d = document.getElementById('dir-in').value;
            const s = document.getElementById('split-in').value;
            const x = document.getElementById('conn-in').value;
            const c = document.getElementById('cont-in').value === 'true' ? '-c ' : '';
            document.getElementById('cmd-out').textContent = `aria2c ${c}-x ${x} -s ${s} -k 1M --file-allocation=${currentAlloc}${d?` -d "${d}"`:''}${o?` -o "${o}"`:''} "${u}"`;
        },
        askDelete: (id, f) => { pendingId = id; pendingFile = f; document.getElementById('del-modal').style.display='flex'; },
        closeModal: () => document.getElementById('del-modal').style.display='none',
        selectAll: (s) => document.querySelectorAll('.his-check').forEach(c => c.checked = s),
        clearAll: () => {
            if(confirm("ç¡®å®šæ¸…ç©ºå½“å‰åº“çš„æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ")) {
                db.transaction("history", "readwrite").objectStore("history").clear().onsuccess = () => handler.render();
            }
        },
        // è¾…åŠ©å·¥å…·ï¼šä¸€é”®æ¸…ç†å†—ä½™åº“
        deepCleanDBS: () => {
            if(confirm("å°†åˆ é™¤å›¾ç‰‡ä¸­åˆ—å‡ºçš„æ‰€æœ‰æ—§ç‰ˆæµ‹è¯•åº“ï¼Œåªä¿ç•™å½“å‰æ´»è·ƒåº“ã€‚ç¡®å®šå—ï¼Ÿ")) {
                DEPRECATED_DBS.forEach(name => indexedDB.deleteDatabase(name));
                alert("æ¸…ç†æŒ‡ä»¤å·²å‘å‡ºï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹ Storage é¢æ¿ã€‚");
            }
        }
    };

    // äº¤äº’é€»è¾‘ï¼šç‚¹å‡»ç²˜è´´
    const pasteAction = async (el, isUrl = false) => {
        try {
            const text = await navigator.clipboard.readText();
            if (!text) return;
            el.value = text;
            if (isUrl && text.startsWith('http')) {
                const path = new URL(text).pathname;
                document.getElementById('out-in').value = decodeURIComponent(path.split('/').pop().split('?')[0]);
            }
            handler.update();
        } catch (err) {}
    };

    document.getElementById('url-in').onclick = (e) => pasteAction(e.target, true);
    document.getElementById('dir-in').onclick = (e) => pasteAction(e.target, false);

    document.getElementById('cmd-out').onclick = function() {
        const val = this.textContent;
        const u = document.getElementById('url-in').value;
        if (!u || u === '[URL]') return;
        db.transaction("history", "readwrite").objectStore("history").add({
            url: u,
            path: (document.getElementById('dir-in').value || '.') + "/" + (document.getElementById('out-in').value || u.split('/').pop()),
            filename: document.getElementById('out-in').value || u.split('/').pop(),
            command: val
        }).onsuccess = () => {
            navigator.clipboard.writeText(val);
            handler.render();
        };
    };

    // å…¶ä»–åˆå§‹åŒ–
    document.querySelectorAll('.alloc-card').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.alloc-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            currentAlloc = card.dataset.val;
            handler.update();
        };
    });

    ['url-in', 'out-in', 'dir-in', 'split-in', 'conn-in', 'cont-in'].forEach(id => document.getElementById(id).oninput = handler.update);

    // ç›®å½•æˆæƒ
    document.getElementById('auth-btn').onclick = async () => {
        try {
            rootHandle = await window.showDirectoryPicker();
            document.getElementById('auth-btn').textContent = `âœ… ç›®å½•: ${rootHandle.name}`;
            handler.update();
        } catch(e) {}
    };

    document.getElementById('confirm-del-btn').onclick = async () => {
        if (document.getElementById('sync-file').checked && rootHandle && pendingFile) {
            try { await rootHandle.removeEntry(pendingFile); await rootHandle.removeEntry(pendingFile + ".aria2"); } catch (e) {}
        }
        db.transaction("history", "readwrite").objectStore("history").delete(pendingId).onsuccess = () => { handler.closeModal(); handler.render(); };
    };

    initDB();
</script>
</body>
</html>
