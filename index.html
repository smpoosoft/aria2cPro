<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aria2c Pro - Power User Edition</title>
    <style>
        /* åŸºç¡€å¤ä½ä¸ Grid éª¨æ¶ */
        * { padding: 0; margin: 0; overflow: hidden; font-size: 14px; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #0d1117; color: #c9d1d9; }

        .wrapper {
            display: grid;
            grid-template-rows: 40px 1fr 80px;
            width: 100vw;
            height: 100vh;
        }

        /* é¡¶éƒ¨æ ‡é¢˜è¡Œ */
        .pageTitle {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: #58a6ff;
            font-weight: bold;
        }

        /* å·¥ä½œåŒºåŸŸ */
        .workzone {
            display: grid;
            grid-template-columns: 1fr 24vw; /* ç¨å¾®åŠ å®½å‚æ•°åŒºä»¥å®¹çº³æè¿° */
            column-gap: 2px;
            background: #30363d;
        }

        /* 1. å·¦ä¾§ï¼šä¸‹è½½å†å²é¢æ¿ */
        .panelHis {
            display: grid;
            grid-template-rows: 64px 1fr;
            background: #0d1117;
        }

        .hisTitle {
            display: inline-flex;
            align-items: center;
            gap: 20px;
            padding: 0 24px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
        }
        .hisTitle span { cursor: pointer; color: #8b949e; font-weight: 500; }
        .hisTitle span:hover { color: #58a6ff; }
        .hisTitle .active-label { color: #f0f6fc; font-size: 1.1rem; }

        .hisList { list-style: none; overflow-y: auto; padding: 16px; }
        .hisItem {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 48px;
            align-items: center;
            min-height: 54px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin-bottom: 8px;
            padding: 0 12px;
            transition: 0.2s;
        }
        .hisItem:hover { border-color: #58a6ff; background: #1c2128; }
        .hisItem span {
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            padding: 0 10px; font-family: 'JetBrains Mono', monospace; font-size: 12px;
        }
        .url-cell { color: #8b949e; cursor: copy; }
        .path-cell { color: #3fb950; cursor: copy; }
        .del-cell { cursor: pointer; text-align: center; color: #f85149; opacity: 0.7; }
        .del-cell:hover { opacity: 1; }

        /* 2. å³ä¾§ï¼šå‚æ•°æ§åˆ¶é¢æ¿ */
        .panelParam {
            background: #161b22;
            padding: 24px;
            border-left: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        .form-field { display: flex; flex-direction: column; gap: 8px; }
        .form-field label { font-size: 12px; color: #8b949e; font-weight: 600; text-transform: uppercase; }
        input, select { background: #0d1117; border: 1px solid #30363d; color: white; padding: 10px; border-radius: 6px; outline: none; }
        input:focus { border-color: #58a6ff; }

        /* é«˜çº§ Allocation é€‰é¡¹å¡ */
        .alloc-container { display: flex; flex-direction: column; gap: 8px; }
        .alloc-card {
            background: #0d1117;
            border: 1px solid #30363d;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .alloc-card.active { border-color: #58a6ff; background: rgba(88, 166, 255, 0.1); }
        .alloc-card:hover:not(.active) { border-color: #8b949e; }
        .alloc-name { font-weight: bold; color: #58a6ff; font-size: 13px; margin-bottom: 4px; }
        .alloc-desc { font-size: 11px; color: #8b949e; line-height: 1.4; white-space: normal; }

        /* åº•éƒ¨ï¼šå‘½ä»¤è¾“å‡ºåŒºåŸŸ */
        .commandZone {
            background: #000;
            border-top: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 60px;
            color: #7ee787;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }
        .commandZone:hover { background: #0d1117; color: #aff5b4; }

        /* æ¨¡æ€å¼¹çª— */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 1000; }
        .modal-body { background: #161b22; border: 1px solid #30363d; padding: 24px; border-radius: 12px; width: 380px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .btn-group { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: 1px solid #30363d; background: #21262d; color: #c9d1d9; font-weight: 600; }
        .btn-danger { background: #f85149; border-color: #f85149; color: white; }
    </style>
</head>
<body>
    <div class="wrapper">
        <header class="pageTitle">
            <span>ARIA2C PRO v2.6.0</span>
            <span id="auth-status" style="font-size: 12px; color: #8b949e; cursor: pointer;">ğŸ” æˆæƒæœ¬åœ°ç›®å½•æƒé™</span>
        </header>

        <div class="workzone">
            <div class="panelHis">
                <div class="hisTitle">
                    <span class="active-label">ä¸‹è½½å†å²</span>
                    <span id="btn-clear-all">æ¸…ç©ºå†å²</span>
                    <span id="btn-select-all">å…¨é€‰</span>
                    <span id="btn-select-rev">åé€‰</span>
                </div>
                <ul class="hisList" id="his-ul">
                    </ul>
            </div>

            <aside class="panelParam">
                <div class="form-field">
                    <label>Download URL</label>
                    <input type="text" id="url-input" placeholder="ç‚¹å‡»ç©ºç™½ç²˜è´´åœ°å€..." autocomplete="off">
                </div>
                <div class="form-field">
                    <label>Save Filename (-o)</label>
                    <input type="text" id="out-input" placeholder="æ–‡ä»¶åå°†è‡ªåŠ¨è§£æ">
                </div>
                <div class="form-field">
                    <label>Directory (-d)</label>
                    <input type="text" id="dir-input" value="/smpoo_code/ai/models/">
                </div>
                <div class="form-field">
                    <label>Threads / Conn</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="number" id="split-input" value="16">
                        <input type="number" id="conn-input" value="16">
                    </div>
                </div>
                <div class="form-field">
                    <label>Allocation Strategy</label>
                    <div class="alloc-container" id="alloc-box">
                        <div class="alloc-card active" data-val="falloc">
                            <div class="alloc-name">falloc</div>
                            <div class="alloc-desc">ç°ä»£ Linux æ¨èã€‚ç¬é—´åˆ†é…æ–‡ä»¶ç©ºé—´ï¼Œä¸äº§ç”Ÿ IO å†™å…¥ï¼Œæé€Ÿå¯åŠ¨ã€‚</div>
                        </div>
                        <div class="alloc-card" data-val="trunc">
                            <div class="alloc-name">trunc</div>
                            <div class="alloc-desc">åˆ©ç”¨ ftruncate ç¬é—´åˆ›å»ºã€‚æå¿«ï¼Œä½†éƒ¨åˆ†æ—§ç‰ˆç³»ç»Ÿå¯èƒ½äº§ç”Ÿç¢ç‰‡ã€‚</div>
                        </div>
                        <div class="alloc-card" data-val="prealloc">
                            <div class="alloc-name">prealloc</div>
                            <div class="alloc-desc">ä¼ ç»Ÿé›¶å¡«å……é¢„å†™ã€‚åœ¨å¼€å§‹ä¸‹è½½å‰ç¡®ä¿ç©ºé—´å®Œå…¨è¿ç»­ï¼Œè€—æ—¶è¾ƒä¹…ã€‚</div>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <footer class="commandZone" id="cmd-output">
            ç­‰å¾…è¾“å…¥ä¸‹è½½åœ°å€...
        </footer>
    </div>

    <div class="modal" id="modal-del">
        <div class="modal-body">
            <h3 style="color: #f85149; margin-bottom: 15px;">ç¡®è®¤åˆ é™¤</h3>
            <p style="font-size: 13px; margin-bottom: 20px; line-height: 1.6;">ç¡®å®šè¦ç§»é™¤æ­¤ä¸‹è½½è®°å½•å—ï¼Ÿ</p>
            <label style="display: flex; align-items:center; gap:10px; font-size: 13px; cursor: pointer; color: #8b949e;">
                <input type="checkbox" id="check-physical" style="width: auto;"> åŒæ—¶ç‰©ç†åˆ é™¤ç¡¬ç›˜ä¸Šçš„æ¨¡å‹æ–‡ä»¶åŠ .aria2 ç¢ç‰‡
            </label>
            <div class="btn-group">
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" id="confirm-del-btn">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

<script type="module">
    let db, rootHandle, pendingId, pendingFile, currentAlloc = 'falloc';

    // 1. IndexedDB åˆå§‹åŒ–
    const request = indexedDB.open("Aria2cPro_Grid", 2);
    request.onupgradeneeded = e => {
        const d = e.target.result;
        if(!d.objectStoreNames.contains("history")) d.createObjectStore("history", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => { db = e.target.result; render(); };

    const els = {
        url: document.getElementById('url-input'),
        out: document.getElementById('out-input'),
        dir: document.getElementById('dir-input'),
        split: document.getElementById('split-input'),
        conn: document.getElementById('conn-input'),
        cmd: document.getElementById('cmd-output'),
        list: document.getElementById('his-ul')
    };

    // 2. äº¤äº’é€»è¾‘
    const updateCmd = () => {
        const u = els.url.value.trim() || '[URL]';
        const o = els.out.value.trim();
        const cmd = `aria2c -c -x ${els.conn.value} -s ${els.split.value} -k 1M --file-allocation=${currentAlloc} -d "${els.dir.value}" ${o ? `-o "${o}"` : ''} "${u}"`;
        els.cmd.textContent = cmd;
    };

    els.url.onclick = async () => {
        if (!els.url.value) {
            const t = await navigator.clipboard.readText();
            if (t.startsWith('http')) {
                els.url.value = t;
                const path = new URL(t).pathname;
                els.out.value = decodeURIComponent(path.split('/').pop().split('?')[0]);
                updateCmd();
            }
        }
    };

    // å¤åˆ¶å¹¶å­˜å…¥å†å²
    els.cmd.onclick = () => {
        if (!els.url.value) return;
        const cmdText = els.cmd.textContent;
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").add({
            url: els.url.value,
            path: els.dir.value + (els.out.value || els.url.value.split('/').pop()),
            filename: els.out.value || els.url.value.split('/').pop(),
            command: cmdText,
            time: new Date().toLocaleTimeString()
        });
        tx.oncomplete = () => {
            navigator.clipboard.writeText(cmdText);
            render();
            alert("âœ… å‘½ä»¤å·²å¤åˆ¶å¹¶è®°å½•å†å²");
        };
    };

    // æˆæƒ
    document.getElementById('auth-status').onclick = async () => {
        rootHandle = await window.showDirectoryPicker();
        document.getElementById('auth-status').textContent = `âœ… ç›®å½•å·²æ¥ç®¡: ${rootHandle.name}`;
    };

    // æ¸²æŸ“
    const render = () => {
        if (!db) return;
        db.transaction("history", "readonly").objectStore("history").getAll().onsuccess = e => {
            els.list.innerHTML = e.target.result.reverse().map(i => `
                <li class="hisItem">
                    <input type="checkbox" class="task-check">
                    <span class="url-cell" title="ç‚¹å‡»å¤åˆ¶åœ°å€" onclick="navigator.clipboard.writeText('${i.url}')">${i.url}</span>
                    <span class="path-cell" title="ç‚¹å‡»å¤åˆ¶è·¯å¾„" onclick="navigator.clipboard.writeText('${i.path}')">${i.path}</span>
                    <div class="del-cell" onclick="askDelete(${i.id}, '${i.filename}')">
                        <svg viewBox="0 0 16 16" fill="currentColor" width="16"><path d="M11 1.75V3h2.25a.75.75 0 010 1.5H2.75a.75.75 0 010-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75zM4.496 6.675a.75.75 0 10-1.492.15l.66 6.6A1.75 1.75 0 005.405 15h5.19c.9 0 1.652-.681 1.741-1.576l.66-6.6a.75.75 0 00-1.492-.149l-.66 6.6a.25.25 0 01-.249.225h-5.19a.25.25 0 01-.249-.225l-.66-6.6z"></path></svg>
                    </div>
                </li>
            `).join('');
        };
    };

    // ç£ç›˜åˆ†é…åˆ‡æ¢
    document.querySelectorAll('.alloc-card').forEach(card => {
        card.onclick = () => {
            document.querySelectorAll('.alloc-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            currentAlloc = card.dataset.val;
            updateCmd();
        };
    });

    // åˆ é™¤é€»è¾‘
    window.askDelete = (id, file) => {
        pendingId = id; pendingFile = file;
        document.getElementById('modal-del').style.display = 'flex';
    };
    window.closeModal = () => document.getElementById('modal-del').style.display = 'none';

    document.getElementById('confirm-del-btn').onclick = async () => {
        if (document.getElementById('check-physical').checked && rootHandle && pendingFile) {
            try {
                await rootHandle.removeEntry(pendingFile);
                await rootHandle.removeEntry(pendingFile + ".aria2");
            } catch (e) { console.warn("ç‰©ç†æ–‡ä»¶æ¸…ç†å¤±è´¥"); }
        }
        const tx = db.transaction("history", "readwrite");
        tx.objectStore("history").delete(pendingId);
        tx.oncomplete = () => { closeModal(); render(); };
    };

    [els.url, els.out, els.dir, els.split, els.conn].forEach(el => el.oninput = updateCmd);
    updateCmd();
</script>
</body>
</html>
