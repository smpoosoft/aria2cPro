<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aria2c Pro - ä¸‹è½½ç®¡ç†åŠ©æ‰‹</title>
    <style>
        :root {
            --primary: #6366f1; --primary-hover: #4f46e5;
            --bg: #0f172a; --panel: #1e293b; --text: #f8fafc;
            --desc: #94a3b8; --border: #334155; --accent: #38bdf8;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* å·¦ä¾§å†å²æ  */
        .history-sidebar { width: 320px; background: rgba(30, 41, 59, 0.7); border-right: 1px solid var(--border); display: flex; flex-direction: column; backdrop-filter: blur(10px); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item { background: rgba(51, 65, 85, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .history-item:hover { border-color: var(--primary); background: rgba(51, 65, 85, 0.8); }
        .history-item .h-name { font-weight: 600; color: var(--text); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .history-item .h-time { font-size: 0.75rem; color: var(--desc); }

        /* å³ä¾§ä¸»é¢æ¿ */
        .main-content { flex: 1; overflow-y: auto; padding: 40px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; }
        header { margin-bottom: 30px; }
        h1 { font-size: 1.8rem; letter-spacing: -0.025em; margin-bottom: 8px; }
        .subtitle { color: var(--desc); font-size: 0.9rem; }

        /* è¡¨å•è®¾è®¡ */
        .section { background: var(--panel); border-radius: 16px; padding: 24px; border: 1px solid var(--border); margin-bottom: 24px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full { grid-column: span 2; }
        .field { display: flex; flex-direction: column; gap: 8px; position: relative; }
        label { font-size: 0.85rem; font-weight: 600; color: var(--desc); }

        input, select { background: #0f172a; border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: white; font-size: 0.95rem; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        .input-with-btn { display: flex; gap: 8px; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn:hover { background: var(--primary-hover); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--desc); }
        .btn-ghost:hover { border-color: var(--desc); color: white; }

        /* ç­–ç•¥å¡ç‰‡ */
        .alloc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .alloc-card { background: #0f172a; border: 1px solid var(--border); padding: 14px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .alloc-card.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .alloc-name { font-weight: bold; color: var(--accent); font-size: 0.9rem; margin-bottom: 4px; }
        .alloc-desc { font-size: 0.75rem; color: var(--desc); line-height: 1.5; }

        /* è¾“å‡ºåŒº */
        .output-box { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid var(--primary); padding: 24px; border-radius: 16px; cursor: pointer; position: relative; }
        #final-cmd { font-family: 'JetBrains Mono', 'Fira Code', monospace; font-size: 0.95rem; color: var(--accent); word-break: break-all; line-height: 1.6; }
        .copy-hint { position: absolute; top: -10px; right: 20px; background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 10px; border-radius: 4px; }

        /* åŠ¨ç”» */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .container { animation: fadeIn 0.4s ease-out; }
    </style>
</head>
<body>

<aside class="history-sidebar">
    <div class="sidebar-header">
        <span>å†å²è®°å½•</span>
        <button class="btn-ghost" id="clear-db" style="font-size: 0.7rem; padding: 4px 8px;">æ¸…ç©ºå†å²</button>
    </div>
    <div class="history-list" id="history-list">
        </div>
</aside>

<main class="main-content">
    <div class="container">
        <header>
            <h1>Aria2c Pro Download Tool</h1>
            <p class="subtitle">é’ˆå¯¹ AI æ¨¡å‹ä¸‹è½½ä¼˜åŒ–çš„å‘½ä»¤ç”Ÿæˆå™¨</p>
        </header>

        <div class="section">
            <div class="grid">
                <div class="field full">
                    <label>æ¨¡å‹ä¸‹è½½ URL (ç‚¹å‡»ç©ºç™½å¤„ç²˜è´´å¹¶è§£æ)</label>
                    <div class="input-with-btn">
                        <input type="text" id="url" placeholder="https://..." autocomplete="off" style="flex:1">
                        <button class="btn-ghost" id="clear-url">æ¸…ç©º</button>
                    </div>
                </div>

                <div class="field">
                    <label>ä¿å­˜æ–‡ä»¶å (-o)</label>
                    <input type="text" id="out" placeholder="è‡ªåŠ¨è§£ææ–‡ä»¶å...">
                </div>

                <div class="field">
                    <label>ä¿å­˜ç›®å½• (-d)</label>
                    <div class="input-with-btn">
                        <input type="text" id="dir" placeholder="/smpoo_code/ai/models/">
                        <button class="btn-ghost" id="pick-dir">ğŸ“</button>
                    </div>
                </div>

                <div class="field">
                    <label>çº¿ç¨‹/è¿æ¥æ•° (-s / -x)</label>
                    <div class="input-with-btn">
                        <input type="number" id="split" value="16" style="width:50%">
                        <input type="number" id="conn" value="16" style="width:50%">
                    </div>
                </div>

                <div class="field">
                    <label>æ–­ç‚¹ç»­ä¼  (-c)</label>
                    <select id="continue">
                        <option value="true">å¼€å¯ (æ¨è)</option>
                        <option value="false">å…³é—­</option>
                    </select>
                </div>

                <div class="field full">
                    <label>ç£ç›˜é¢„åˆ†é…ç­–ç•¥ (--file-allocation)</label>
                    <div class="alloc-grid" id="alloc-container">
                        <div class="alloc-card active" data-value="falloc">
                            <div class="alloc-name">falloc</div>
                            <div class="alloc-desc">ç°ä»£ Linux æ¨èã€‚ç¬é—´åˆ†é…æµ·é‡ç©ºé—´ï¼Œä¸å  IO å¸¦å®½ã€‚</div>
                        </div>
                        <div class="alloc-card" data-value="trunc">
                            <div class="alloc-name">trunc</div>
                            <div class="alloc-desc">é€šè¿‡ ftruncate ç¬é—´åˆ›å»ºã€‚æé€Ÿï¼Œé€‚åˆä¸»æµæ–‡ä»¶ç³»ç»Ÿã€‚</div>
                        </div>
                        <div class="alloc-card" data-value="prealloc">
                            <div class="alloc-name">prealloc</div>
                            <div class="alloc-desc">ä¼ ç»Ÿé›¶å¡«å……ã€‚åœ¨å¼€å§‹ä¸‹è½½å‰å®Œå…¨é¢„å†™ç©ºé—´ã€‚</div>
                        </div>
                        <div class="alloc-card" data-value="none">
                            <div class="alloc-name">none</div>
                            <div class="alloc-desc">ä¸åˆ†é…ç©ºé—´ã€‚è¾¹ä¸‹è¾¹å†™ï¼Œå¯èƒ½å¯¼è‡´ç¢ç‰‡ã€‚</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="output-box" id="copy-zone">
            <span class="copy-hint">ç‚¹å‡»å¤åˆ¶å¹¶å­˜å…¥å†å²</span>
            <div id="final-cmd">aria2c ...</div>
        </div>
    </div>
</main>

<script type="module">
    let db;
    let currentAlloc = 'falloc';

    // 1. IndexedDB åˆå§‹åŒ–
    const request = indexedDB.open("localAria2c", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("downloads", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        renderHistory();
    };

    // 2. æ ¸å¿ƒå…ƒç´ è·å–
    const els = {
        url: document.getElementById('url'),
        out: document.getElementById('out'),
        dir: document.getElementById('dir'),
        split: document.getElementById('split'),
        conn: document.getElementById('conn'),
        cont: document.getElementById('continue'),
        cmd: document.getElementById('final-cmd'),
        hist: document.getElementById('history-list'),
        cards: document.querySelectorAll('.alloc-card')
    };

    // 3. æ™ºèƒ½æ–‡ä»¶åè§£æ
    function parseFileName(url) {
        try {
            const path = new URL(url).pathname;
            let filename = path.substring(path.lastIndexOf('/') + 1);
            // å¤„ç†å¸¸è§çš„é•œåƒç«™åç¼€
            if (filename.includes('?')) filename = filename.split('?')[0];
            return decodeURIComponent(filename) || '';
        } catch (e) { return ''; }
    }

    // 4. URL ç²˜è´´é€»è¾‘
    els.url.onclick = async () => {
        if (!els.url.value) {
            const text = await navigator.clipboard.readText();
            if (text.startsWith('http')) {
                els.url.value = text;
                const fileName = parseFileName(text);
                if (fileName) els.out.value = fileName;
                update();
            }
        }
    };

    els.url.oninput = () => {
        const fileName = parseFileName(els.url.value);
        if (fileName) els.out.value = fileName;
        update();
    };

    // 5. çŠ¶æ€æ›´æ–°
    function update() {
        const u = els.url.value.trim() || '[URL]';
        const d = els.dir.value.trim() || '/smpoo_code/ai/models/';
        const o = els.out.value.trim();
        const s = els.split.value;
        const x = els.conn.value;
        const c = els.cont.value === 'true' ? ' -c' : '';

        let base = `aria2c${c} -x ${x} -s ${s} -k 1M --file-allocation=${currentAlloc}`;
        base += ` -d "${d}"`;
        if (o) base += ` -o "${o}"`;
        base += ` "${u}"`;

        els.cmd.textContent = base;
    }

    // 6. æ•°æ®åº“æ“ä½œ
    function saveToHistory(command, name) {
        const tx = db.transaction("downloads", "readwrite");
        tx.objectStore("downloads").add({
            name: name || 'æœªå‘½åä»»åŠ¡',
            command: command,
            time: new Date().toLocaleString()
        });
        tx.oncomplete = renderHistory;
    }

    function renderHistory() {
        if (!db) return;
        const tx = db.transaction("downloads", "readonly");
        const store = tx.objectStore("downloads");
        store.getAll().onsuccess = e => {
            const data = e.target.result.reverse(); // æœ€æ–°çš„åœ¨å‰
            els.hist.innerHTML = data.map(item => `
                <div class="history-item" onclick="navigator.clipboard.writeText('${item.command}')">
                    <div class="h-name">${item.name}</div>
                    <div class="h-time">${item.time}</div>
                </div>
            `).join('');
        };
    }

    // 7. äº‹ä»¶ç›‘å¬
    document.getElementById('copy-zone').onclick = () => {
        const cmdText = els.cmd.textContent;
        navigator.clipboard.writeText(cmdText).then(() => {
            saveToHistory(cmdText, els.out.value || parseFileName(els.url.value));
            alert('å·²æˆåŠŸå¤åˆ¶å¹¶å­˜å…¥å†å²è®°å½•ï¼');
        });
    };

    document.getElementById('clear-db').onclick = () => {
        const tx = db.transaction("downloads", "readwrite");
        tx.objectStore("downloads").clear();
        tx.oncomplete = renderHistory;
    };

    document.getElementById('clear-url').onclick = () => { els.url.value = ''; els.out.value = ''; update(); };

    els.cards.forEach(card => {
        card.onclick = () => {
            els.cards.forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            currentAlloc = card.dataset.value;
            update();
        };
    });

    [els.url, els.out, els.dir, els.split, els.conn, els.cont].forEach(el => el.oninput = update);

    // æ–‡ä»¶å¤¹ API
    document.getElementById('pick-dir').onclick = async () => {
        try {
            const handle = await window.showDirectoryPicker();
            els.dir.value = `/smpoo_code/ai/models/${handle.name}`;
            update();
        } catch (e) {}
    };

    update();
</script>
</body>
</html>
